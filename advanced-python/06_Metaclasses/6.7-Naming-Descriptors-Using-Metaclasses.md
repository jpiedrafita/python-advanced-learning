# 6.7 Naming Descriptors Using Metaclasses

## Key Ideas

- **Descriptor Naming Problem**: Descriptors cannot inherently know which class attribute they are bound to
- **Metaclass Solution**: Use metaclasses to automatically assign attribute names to descriptors during class creation
- **Enhanced Error Messages**: Named descriptors can provide more informative error messages
- **Automatic Association**: Metaclasses can establish the descriptor-to-attribute relationship that Python doesn't provide by default

## The Descriptor Naming Problem

### Original Implementation

```python
from weakref import WeakKeyDictionary

class Positive:
    def __init__(self):
        self._instance_data = WeakKeyDictionary()

    def __get__(self, instance, owner):
        if instance is None:
            return self
        return self._instance_data[instance]

    def __set__(self, instance, value):
        if value <= 0:
            raise ValueError("Value {} is not positive".format(value))
        self._instance_data[instance] = value

    def __delete__(self, instance):
        raise AttributeError("Cannot delete attribute")

class Planet:
    def __init__(self,
                 name,
                 radius_metres,
                 mass_kilograms,
                 orbital_period_seconds,
                 surface_temperature_kelvin):
        self.name = name
        self.radius_metres = radius_metres
        self.mass_kilograms = mass_kilograms
        self.orbital_period_seconds = orbital_period_seconds
        self.surface_temperature_kelvin = surface_temperature_kelvin
```

**Limitation**: The `Positive` descriptor instances have no knowledge of which class attribute they are bound to, limiting error message informativeness.

![Descriptors](../images/which-descriptor.png)

**Core Issue**: Descriptor instances (e.g., bound to `Planet.radius_metres`) cannot determine their attribute names because Python's class definition machinery doesn't establish this association.

### Demonstrating the Problem

```python
>>> from planet import *
>>> mercury, venus, earth, mars = make_planets()
>>> mercury.mass_kilograms = -10000
Traceback (most recent call last):
  File "<input>", line 1, in <module>
  File "/Users/rjs/training/tmp/metaclass/planet.py", line 16, in __set__
    raise ValueError("Value {} is not positive".format(value))
ValueError: Value -10000 is not positive
# No mention mass_kilograms
```

**Problem Illustration**: The error message lacks context about which attribute (`mass_kilograms`) triggered the exception, making debugging more difficult.

## Solution: Named Descriptor Base Class

```python
class Named:

    def __init__(self, name=None):
        self.name = name
```

**Named Base Class Features**:
- **Simple Interface**: Provides `name` attribute for storing the associated class attribute name
- **Default Value**: Constructor accepts `name=None` since the name will be assigned later by the metaclass
- **Foundation**: Serves as a base class for descriptors that need to know their attribute names

### Enhanced Positive Descriptor

```python
class Positive(Named):

    def __init__(self, name=None):
        super().__init__(name)
        self._instance_data = WeakKeyDictionary()

    def __get__(self, instance, owner):
        if instance is None:
            return self
        return self._instance_data[instance]

    def __set__(self, instance, value):
        if value <= 0:
            raise ValueError("Attribute value {} {} is not positive".format(self.name, value))
        self._instance_data[instance] = value

    def __delete__(self, instance):
        raise AttributeError("Cannot delete attribute {}".format(self.name))
```

**Enhancements**:
- **Inheritance**: Extends `Named` to gain the `name` attribute
- **Constructor Compatibility**: Maintains `name=None` default for initial construction
- **Improved Error Messages**: Uses `self.name` in `__set__` and `__delete__` error messages for better diagnostics
- **Backward Compatibility**: Preserves original functionality while adding naming capability

## The Descriptor Naming Metaclass

```python
class DescriptorNamingMeta(type):

    def __new__(mcs, name, bases, namespace):
        for name, attr in namespace.items():
            if isinstance(attr, Named):
                attr.name = name
        return super().__new__(mcs, name, bases, namespace)
```

**DescriptorNamingMeta Functionality**:
- **Attribute Detection**: Iterates through the class namespace to find `Named` instances
- **Name Assignment**: Automatically assigns the attribute name to each `Named` descriptor's `name` attribute
- **Metaclass Integration**: Operates during class creation via `__new__` method
- **Transparent Operation**: Modifies descriptors before delegating to parent `__new__`

**Process**:
1. **Iterate Namespace**: Examine each name-attribute pair in the class namespace
2. **Identify Descriptors**: Check if attribute is an instance of `Named`
3. **Assign Names**: Set the `name` attribute to the corresponding class attribute name
4. **Create Class**: Call parent `__new__` to complete class creation

### Applying the Metaclass

```python
class Planet(metaclass=DescriptorNamingMeta):
    # ... class implementation remains unchanged
```

**Integration Requirements**:
- **Single Change**: Only the metaclass specification needs to be added to the class definition
- **No Descriptor Modification**: Existing `Positive` descriptor usage remains unchanged
- **Automatic Processing**: The metaclass handles name assignment during class creation
- **Default Behavior**: Descriptors start with `name=None` and get assigned actual names by the metaclass

## Result: Enhanced Error Messages

```python
>>> from planet import *
>>> mercury, venus, earth, mars = make_planets()
>>> mercury.mass_kilograms
3.3022e+23
>>> mercury.mass_kilograms = -10000
Traceback (most recent call last):
  File "<input>", line 1, in <module>
  File "/Users/rjs/training/tmp/metaclass/planet.py", line 23, in __set__
    raise ValueError("Attribute value {} {} is not positive".format(self.name, value))
ValueError: Attribute value mass_kilograms -10000 is not positive
```

**Improvement Achieved**: The error message now clearly identifies the specific attribute (`mass_kilograms`) that caused the validation failure, making debugging significantly easier.

## Summary

This metaclass example demonstrates how to solve the descriptor naming problem:

- **Problem**: Descriptors cannot inherently know their associated attribute names
- **Solution**: Use a metaclass to automatically assign names during class creation
- **Implementation**: Combine a `Named` base class with a naming metaclass
- **Benefits**: 
  - Enhanced error messages with attribute context
  - Automatic name assignment without manual intervention
  - Improved debugging experience
  - Clean integration with existing descriptor code

**Key Takeaway**: Metaclasses can enhance existing patterns like descriptors by automating tedious or error-prone tasks, improving both functionality and developer experience.
