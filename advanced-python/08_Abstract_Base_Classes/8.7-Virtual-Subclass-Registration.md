# 8.7 Virtual Subclass Registration

## Key Ideas

- **Direct Registration**: ABCMeta provides a `register()` method for explicitly registering virtual subclasses
- **Return Value**: `register()` returns the registered class, enabling its use as a decorator
- **Retrofitting Built-ins**: Virtual registration allows adding abstract base classes to built-in types
- **Decorator Pattern**: `@BaseClass.register` syntax provides convenient class decoration

---

## The register() Method

### Explicit Virtual Subclass Registration

`ABCMeta` provides the `register()` method for directly establishing virtual subclass relationships without requiring protocol compliance checks:

```python
BaseClass.register(SubClass)
```

**Characteristics:**

- Available on all classes using `ABCMeta` as their metaclass
- Creates virtual subclass relationship explicitly
- Does not require `__subclasshook__` implementation
- Returns the registered class for further use

---

## Registering Built-in Types

### Creating Text ABC and Registering str

```python
>>> from abc import ABCMeta
>>>
>>> class Text(metaclass=ABCMeta):
...     pass
...
>>> Text.register(str)
<class 'str'>
>>>
>>> issubclass(str, Text)
True
>>> isinstance("Is this text?", Text)
True
```

### Analysis

**Registration Process:**

1. Define `Text` as an abstract base class using `ABCMeta`
2. Call `Text.register(str)` to register `str` as a virtual subclass
3. Method returns `<class 'str'>`, confirming the registration

**Verification:**

- `issubclass(str, Text)` returns `True` after registration
- String literals like `"Is this text?"` pass `isinstance()` checks against `Text`
- Virtual base class relationship established without modifying `str`

**Retrofitting Capabilities:**

- Built-in types can receive virtual base classes after definition
- No access to source code required
- Enables categorization of existing types into new hierarchies

---

## Using register() as a Decorator

### Decorator Syntax

Since `register()` returns its argument class, it can be used as a class decorator:

```python
>>>
>>> @Text.register
... class Prose:
...     pass
...
>>> issubclass(Prose, Text)
True
```

### How It Works

**Decorator Mechanics:**

```python
@Text.register
class Prose:
    pass

# Equivalent to:
class Prose:
    pass
Prose = Text.register(Prose)
```

**Key Points:**

1. `@Text.register` applies the `register()` method as a decorator
2. `Prose` is passed to `Text.register()`
3. `register()` returns `Prose` after registration
4. `Prose` name binds to the returned class (same object)

**Result:**

- `Prose` is registered as a virtual subclass of `Text`
- `issubclass(Prose, Text)` returns `True`
- Clean, declarative syntax at class definition time

---

## Comparison: register() vs __subclasshook__

### Two Approaches to Virtual Subclasses

| Aspect | `register()` Method | `__subclasshook__()` Method |
|--------|-------------------|---------------------------|
| **Registration** | Explicit, per-class | Implicit, protocol-based |
| **Flexibility** | Manual control | Automatic detection |
| **Use Case** | Known types, retrofitting | Duck typing, open protocols |
| **Checking** | None (trust-based) | Validates protocol compliance |
| **When Applied** | At registration time | At `isinstance()`/`issubclass()` time |

### When to Use register()

**Appropriate Scenarios:**

- Registering third-party or built-in types as virtual subclasses
- Explicit control over subclass relationships
- Types that don't fully implement protocol but should be included
- Performance optimization (no repeated protocol checks)

### When to Use __subclasshook__

**Appropriate Scenarios:**

- Open protocols where any compliant class should qualify
- Duck typing with automatic recognition
- Dynamic subclass determination based on capabilities
- Encouraging protocol implementation without explicit registration

---

## Practical Implications

### Retrofitting Type Hierarchies

Virtual registration enables organizing existing types into logical hierarchies:

```python
class Numeric(metaclass=ABCMeta):
    pass

Numeric.register(int)
Numeric.register(float)
Numeric.register(complex)

# Now all numeric types are considered Numeric subclasses
```

### Combining Approaches

A single ABC can use both registration and protocol checking:

- `register()` for specific known types
- `__subclasshook__()` for dynamic protocol compliance
- Provides flexibility for different use cases

---

## Summary

The `register()` method provided by `ABCMeta` enables explicit registration of virtual subclasses, including built-in types that cannot be modified directly. The method returns the registered class, allowing its use as a decorator with `@BaseClass.register` syntax. Virtual registration complements protocol-based checking with `__subclasshook__()`, offering two distinct approaches: explicit registration for known types and automatic detection for protocol-compliant classes. This flexibility allows retrofitting existing type hierarchies and precise control over virtual subclass relationships.
