# Demo Row Factories

- Define the dataclass to represent an investment

```python
from dataclasses import dataclass

@dataclass
class Investment:
	coin_id: str
	currency: str
	amount: float
	sell: bool
	date: datetime.datetime

	def compute_value(self) -> float:
		return self.amount * get_coin_price(self.coin_id, self.currency)
```

- Define the factory function to create an Investment object from a database row

```python
def investment_row_factory(_, row):
	return Investment(
		coin_id=row[0],
		currency=row[1],
		amount=row[2],
		sell=bool(row[3]),
		date=datetime.datetime.strptime(row[4], "%Y-%m-%d %H:%M:%S.%f"),
	)
...
```

- Set the row factory of the database, beore creating the cursor

```python
if __name__ == "__main__":
	database = sqlite3.connect("portfolio.db")

	database.row_factory = investment_row_factory
	cursor = database.cursor()
	cursor.execute(CREATE_INVESTMENTS_SQL)
	cli()
```

- Adapt the ```get_investment_value()``` function to select all columns and then attributes can be called by name instead of index

```python
@click.command()
@click.option("--coin_id")
@click.option("--currency")
def get_investment_value(coin_id, currency):
	coin_price = get_coin_price(coin_id, currency)
	print(f"Current price of {coin_id} in {currency} is {coin_price:.2f}")
	# Select all
	sql = """SELECT *
	FROM investments
	WHERE coin_id = ?
	AND currency = ?
	AND sell=?;"""
	buy_result = cursor.execute(sql, (coin_id, currency, False)).fetchall()
	sell_result = cursor.execute(sql, (coin_id, currency, True)).fetchall()
	# Call amount by attribute name instead by index
	# buy_amount = sum(row[0] for row in buy_result)
	# sell_amount = sum(row[0] for row in sell_result)
	buy_amount = sum(row.amount for row in buy_result)
	sell_amount = sum(row.amount for row in sell_result)
	total = buy_amount - sell_amount
	print(
		f"You own a total of {total} {coin_id} worth {total * coin_price:.2f} {currency.upper()}"
	)
```

- Usage

```bash
❯ python row_factories.py get-investment-value --coin_id=bitcoin --currency=usd
Current price of bitcoin in usd is 104669.00
You own a total of 0.75 bitcoin worth 78501.75 USD
```

- Now ```fetchall()``` returns an instance of ```Investment```instead a tuple.
	- Values can be accessed by name
	- Class methods can be used in the results

```python
❯ ipython
Python 3.12.4 (main, Jun  6 2024, 18:26:44) [Clang 15.0.0 (clang-1500.3.9.4)]
Type 'copyright', 'credits' or 'license' for more information
IPython 9.3.0 -- An enhanced Interactive Python. Type '?' for help.
Tip: Use `--theme`, or the `%colors` magic to change IPython's themes and colors.

In [1]: from row_factories import Investment, investment_row_factory

In [2]: import sqlite3

In [3]: database = sqlite3.connect("portfolio.db")

In [4]: database.row_factory = investment_row_factory

In [5]: cursor = database.cursor()

In [6]: result = cursor.execute("SELECT * FROM investments;")

In [7]: row = result.fetchone()

In [8]: row
Out[8]: Investment(coin_id='bitcoin', currency='usd', amount=1.0, sell=False, date=datetime.datetime(2023, 1, 17, 0, 59, 52, 156876))

In [9]: row.amount
Out[9]: 1.0

In [10]: row.compute_value()
Out[10]: 104579.0
```