

- The [[Courses/python-advanced-learning/Working with Databases in Python/05 Using a NoSQL Database- MongoDB and PyMongo/demo/utils.py]] file:
	- ```seed_data()``` will insert some watchlists into the database with a random date in the past 7 days.
	- ```get_coin_prices()``` will return a dictionary of coins and prices in a currency.
- The [[Courses/python-advanced-learning/Working with Databases in Python/05 Using a NoSQL Database- MongoDB and PyMongo/demo/manager.py|manager]] imports the necessary modules

```python
import datetime

import click
from bson import ObjectId
from pymongo import MongoClient 

from utils import get_coin_prices
from utils import seed_data as utils_seed_data
```

- Then the ```MongoClient``` connects to the default local server and get the portfolio database, and the watchlists collection in the database

```python
client = MongoClient()
portfolio = client.portfolio
watchlists = portfolio.watchlists
```

- The ```clear_data``` command is an utility that drops the watchlists collection in the database.

```python
@click.command(help="Clear the database")
def clear_data():
	portfolio.drop_collection("watchlists")
	print("All data cleared!")
```

- The ```seed_data``` command will add the watchlist from the ```seed_data()``` function.
	- By default only if it is empty.
	- It can be forced with ```--force```.

```python
@click.command(help="Seed the database")
@click.option("--force", is_flag=True, help="Seed even if database is not empty")
def seed_data(force):
	if force:
		utils_seed_data(watchlists)
	elif watchlists.count_documents({}) > 0:
		print(
			"The database is not empty, use the --force option or the clear-data command"
		)
	else:
		utils_seed_data(watchlists)
```

- Most of the commands need to select one of the watchlists, so there are some helpers.
- The ```_get_all_watchlist_names``` function simply returns a list of the watchlist names and IDs.
	- No matter what fields are put in the projection document, the object ID will always be returned with them.

```python
def _get_all_watchlist_names():
	return list(watchlists.find({}, {"name": 1}))
```

- The ```_select_watchlist``` function will display a list of the names and prompt the user to select one, then it will return the ```ObjectId```.

```python
def _select_watchlist(watchlist_names):
	for index, watchlist in enumerate(watchlist_names):
		print(f"{index + 1}: {watchlist['name']}")
	selected_watchlist_index = int(input("Select a watchlist: ")) - 1
	selected_watchlist_id = watchlist_names[selected_watchlist_index]["_id"]
	return watchlists.find_one({"_id": ObjectId(selected_watchlist_id)})
```

- The ```view_watchlists``` function uses the watchlist to display the name, currency, and description.
	- Notice that the embedded metadata document becomes a nested dictionary.
	- Then, display the coins and their currency prices in a list.
	- Use a list comprehension to get the coin names from the coins list of the watchlist, and along with the currency, call the get_coin_prices function.
	- Print each coin name and note, and on a new line.
	- Print the current price from CoinGecko.

```python
def view_watchlist():
	selected_watchlist = _select_watchlist(_get_all_watchlist_names())
	print(
		f"Watchlist: {selected_watchlist['name']} in {selected_watchlist['metadata']['currency']}"
	)
	print(f"{selected_watchlist['metadata']['description']}")
	print(f"{'-' * 25}")
	print("Coins:")
	coin_prices = get_coin_prices(
		[coin["coin"] for coin in selected_watchlist["coins"]],
		selected_watchlist["metadata"]["currency"],
	)
	for index, coin in enumerate(selected_watchlist["coins"]):
		print(f"{str(index + 1).rjust(3, ' ')}: {coin['coin']} - {coin['note']}")
		print(f" Current price: {coin_prices[coin['coin']]}")
	print("Prices provided by CoinGecko")
```

- The ```add_watchlist``` command accepts from the command line or prompts a name, description, and currency.
	- The description and currency are used along with the current datetime to create a metadata document. 
	- The metadata will be embedded as a field of the watchlist document that will include the name and an empty list for the coins.
	- The ```insert_one``` method will add the watchlist document to the watchlists collection in the portfolio.

```python
@click.command(help="Add a new watchlist to the portfolio")
@click.option("--name", prompt=True, help="Name of the watchlist")
@click.option("--description", prompt=True, help="Description of the watchlist")
@click.option("--currency", prompt=True, help="Currency to display prices")
def add_watchlist(name, description, currency):
	metadata = {
		"description": description,
		"currency": currency,
		"date_added": datetime.datetime.now(),
	}
	# The netadata is embedded as a field of the watchlist document
	watchlist = {"name": name, "metadata": metadata, "coins": []}
	watchlists.insert_one(watchlist)

	print(f"Added new {name} watchlist")
```

- To add a coin to a watchlist, use the ```add_coin``` command.
	- From either the command line or prompts.
	- Select a watchlist, the ```_add_coin_to_watchlist``` helper makes a filter document to select the watchlist with the object ID. 
		- Then it makes an update document to push  the coin in the coins list of the watchlist. 
		- Then the ```update_one``` method does the heavy lifting.

```python
@click.command(help="Add a new coin to a watchlist")
@click.option("--coin", prompt=True, help="The coin to add")
@click.option("--note", prompt=True, help="A note")
def add_coin(coin, note):
	selected_watchlist = _select_watchlist(_get_all_watchlist_names())
	_add_coin_to_watchlist(
		selected_watchlist["_id"],
		{"coin": coin, "note": note, "date_added": datetime.datetime.now()},
	)
	print(f"Added {coin} to {selected_watchlist['name']}")

def _add_coin_to_watchlist(watchlist_oid, coin):
	filter = {"_id": ObjectId(watchlist_oid)}
	update = {"$push": {"coins": coin}}
	watchlists.update_one(filter, update)
```


- To remove a coin is similar. 
	- Get a watchlist.
	- Then we need to get the coin to remove.
	- The ```_select_coin_from_watchlist``` function:
		- Takes a watchlist and lists the coins.
		- It prompts the user for selection.
		- It returns the selected coin
	- The watchlist and coin are used in the ```remove_coin_from_watchlist``` function.
		- It makes a filter document with the ObjectId of the watchlist.
		- It makes an update document to pull a coin from the coins list of the watchlist.
		- The ```update_one``` method takes care of business for us.

```python
@click.command(help="Remove a coin from a watchlist")
def remove_coin():
	selected_watchlist = _select_watchlist(_get_all_watchlist_names())
	selected_coin = _select_coin_from_watchlist(selected_watchlist)
	_remove_coin_from_watchlist(selected_watchlist["_id"], selected_coin["coin"])
	print(f"Removed {selected_coin['coin']} from {selected_watchlist['name']}")

  

def _select_coin_from_watchlist(watchlist):
	for index, coin in enumerate(watchlist["coins"]):
		print(f"{index + 1}: {coin['coin']}")
	selected_coin_index = int(input("Select a coin: ")) - 1
	return watchlist["coins"][selected_coin_index]

def _remove_coin_from_watchlist(watchlist_oid, selected_coin):
	filter = {"_id": ObjectId(watchlist_oid)}
	update = {"$pull": {"coins": {"coin": selected_coin}}}
	watchlists.update_one(filter, update)
```

- List all the commands

```bash
❯ python manager.py
Usage: manager.py [OPTIONS] COMMAND [ARGS]...

Options:
  --help  Show this message and exit.

Commands:
  add-coin        Add a new coin to a watchlist
  add-watchlist   Add a new watchlist to the portfolio
  clear-data      Clear the database
  remove-coin     Remove a coin from a watchlist
  seed-data       Seed the database
  view-watchlist  View the coins and current prices of a watchlist

❯ python manager.py add-watchlist --help
Usage: manager.py add-watchlist [OPTIONS]

  Add a new watchlist to the portfolio

Options:
  --name TEXT         Name of the watchlist
  --description TEXT  Description of the watchlist
  --currency TEXT     Currency to display prices
  --help              Show this message and exit.
```

- Clear the database and seed data.

```bash
❯ python manager.py clear-data
All data cleared!

❯ python manager.py seed-data
```

- Take a look at the watchlist.

```bash
❯ python manager.py view-watchlist
1: Bulls
2: Bears
Select a watchlist: 1
Watchlist: Bulls in usd
Coins to buy
-------------------------
Coins:
  1: bitcoin - The most popular coin
     Current price: 101748
  2: ethereum - The second most popular coin
     Current price: 2282.81
Prices provided by CoinGecko

❯ python manager.py view-watchlist
1: Bulls
2: Bears
Select a watchlist: 2
Watchlist: Bears in usd
Coins to hold or sell
-------------------------
Coins:
  1: solana - Don't sell this one yet
     Current price: 134.98
Prices provided by CoinGecko
```

- Add a new watchlist and a coin to the watchlist.

```bash
❯ python manager.py add-watchlist
Name: My Watchlist
Description: It's a watchlist!     
Currency: usd
Added new My Watchlist watchlist

❯ python manager.py add-coin
Coin: dogecoin
Note: It's a joke!
1: Bulls
2: Bears
3: My Watchlist
Select a watchlist: 3
Added dogecoin to My Watchlist
```

- View the watchlist

```bash
❯ python manager.py view-watchlist
1: Bulls
2: Bears
3: My Watchlist
Select a watchlist: 3
Watchlist: My Watchlist in usd
It's a watchlist!
-------------------------
Coins:
  1: dogecoin - It's a joke!
     Current price: 0.154264
Prices provided by CoinGecko
```

- Remove a coin

```bash
❯ python manager.py remove-coin
1: Bulls
2: Bears
3: My Watchlist
Select a watchlist: 1
1: bitcoin
2: ethereum
Select a coin: 2
Removed ethereum from Bulls

❯ python manager.py view-watchlist
1: Bulls
2: Bears
3: My Watchlist
Select a watchlist: 1
Watchlist: Bulls in usd
Coins to buy
-------------------------
Coins:
  1: bitcoin - The most popular coin
     Current price: 101751
Prices provided by CoinGecko
```