

- Set up ```mongita``` and create the ```MongitaClientDisk```.
	- The table and the database will be created after the first run

```pip install mongita```


```python
from mongita import MongitaClientDisk
```

- ```add_investments``` command.
	- To insert the document into Mongita, create a ```dict``` that represents the document.
	- We need to use the string representation for the timestamp because by default, Python doesn't know how to JSON encode a ```datatime```.

```python
@click.command()
@click.option("--coin_id")
@click.option("--currency")
@click.option("--amount", type=float)
@click.option("--sell", is_flag=True)
def add_investment(coin_id, currency, amount, sell):
	# Dictionary that represents the investment document
	investment_document = {
		"coin_id": coin_id,
		"currency": currency,
		"amount": amount,
		"sell": sell,
		"timestamp": datetime.datetime.now().strftime("%Y/%m/%d %H:%M:%S"),
	}
	# Insert the investment document into the investments collection
	investments.insert_one(investment_document)
```

- ```get_investment_value``` command preserves the calculation logic.
	- Filter the document for the buys and sells
	- Mongo will return a list of JSON documents (```squlite3``` returned  a list of touples)

```python
@click.command()
@click.option("--coin_id")
@click.option("--currency")
def get_investment_value(coin_id, currency):
	coin_price = get_coin_price(coin_id, currency)
	# Filter the document for the buys and sells
	buy_result = investments.find(
		{"coin_id": coin_id, "currency": currency, "sell": False}
	)
	sell_result = investments.find(
		{"coin_id": coin_id, "currency": currency, "sell": True}
	)
	# Mongita retrurns a list of documents, so we need to access the amount field
	buy_amount = sum(doc["amount"] for doc in buy_result)
	sell_amount = sum(doc["amount"] for doc in sell_result)

	total = buy_amount - sell_amount
	
	print(
		f"You own a total of {total} {coin_id} worth {total * coin_price:.2f} {currency.upper()}"
	)
```

```bash
❯ python main.py add-investment --coin_id=bitcoin --currency=usd --amount=1.0
Added buy of 1.0 bitcoin
```

- There is no Mongita VSCode extension, but we can check in the console.
	- Notice that Mongita added an ```_id```field of type ```ObjectId``` that uniquely will identify the document.

```python
❯ ipython
Python 3.12.4 (main, Jun  6 2024, 18:26:44) [Clang 15.0.0 (clang-1500.3.9.4)]
Type 'copyright', 'credits' or 'license' for more information
IPython 9.3.0 -- An enhanced Interactive Python. Type '?' for help.
Tip: You can use `%hist` to view history, see the options with `%history?`

In [1]: from mongita import MongitaClientDisk
   ...: 

In [2]: client = MongitaClientDisk()

In [3]: db = client.portfolio

In [4]: investments = db.investments

In [5]: list(investments.find({}))

In [6]: list(investments.find({}))
Out[6]: 
[{'_id': ObjectId('68583a2f667a53af9b0096fc'),
  'coin_id': 'bitcoin',
  'currency': 'usd',
  'amount': 1.0,
  'sell': False,
  'timestamp': '2025/06/22 19:15:27'}]
```

- Add a few more investments

```bash
❯ python main.py add-investment --coin_id=bitcoin --currency=usd --amount=0.5 --sell
Added sell of 0.5 bitcoin
❯ python main.py add-investment --coin_id=ethereum --currency=usd --amount=10.0
Added buy of 10.0 ethereum
❯ python main.py get-investment-value --coin_id=bitcoin --currency=usd
You own a total of 0.5 bitcoin worth 49906.00 USD
```

