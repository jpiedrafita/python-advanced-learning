

# Embedded Documents with MongoEngine

- For a document that is to be embedded in another document or be in a list, the ```Document``` model class must derive from ```EmbeddedDocument```.

```python
from mongoengine import Document, EmbeddedDocument
from mongoengine import fields
```

- The watchlist will have metadata in the EmbeddedDocument. The WatchlistMetadata class will be an embedded document, and thus, derived from the EmbeddedDocument class.

```python
class WatchlistMetadata(EmbeddedDocument)
```

- We can add fields using the types in the ```mongoengine.fields``` module. 

```python
class WatchlistMetadata(EmbeddedDocument):
	currency = fields.StringField(max_length=3)
	description = fields.StringField()
	date_created = fields.DateField(default=datetime.datetime.now().date)
	
```

- Now the Watchlist document will derive from the Document class and it will have a string field for the name.
- The metadata for the watchlist will be an ```EmbeddedDocumentField```, and we must tell MongoEngine the type of the embedded document it will contain.

```python
class Watchlist(Document):
	name = fields.StringField(max_length=256)
	metadata = fields.EmbeddedDocumentField(WatchlistMetadata)
```

-  Each watchlist will maintain a list of coins, and the coin documents will be embedded documents.
- The coins field in the watchlist will be of the type ```EmbeddedDocumentListField```, and we must tell MongoEngine the type of the embedded document in the list.

```python
class WatchlistCoin(EmbeddedDocument):
	coin = fields.StringField(max_length=32)
	note = fields.StringField()
	date_added = fields.DateField(default=datetime.datetime.now().date)

class Watchlist(Document):
	name = fields.StringField(max_length=256)
	metadata = fields.EmbeddedDocumentField(WatchlistMetadata)
	coins = fields.EmbeddedDocumentField(WatchlistCoin)

```

# Creating Documents with MongoEngine

- Creating an embedded document is no different than creating a document, call the initializer and use keyword arguments for the field names.

```python
metadata = WatchlistMetadata(description="It¡s a watchlist", currency="USD")
```

- Now you can assign the embedded document to an embedded document field in another document.

```python
watchlist = watchlist(name="My Watchlist", metadata=metadata, coins=[])
```

- The ```EmbeddedDocumentListField``` supports the Python List API, so we can use the append method to add a new WatchListCoin to the coins field.

```python
watchlist.coins.append(WatchlistCoin(coin="dogecoin", note="It's a joke!"))
```

- Saving the watchlist will save the embedded document for the embedded document field and the embedded documents for the ```EmbeddedDocumentListField```.

```python
watchlist.save()
```

# Querying Embedded Documents and Lists

- To query an ```EmbeddedDocument``` field, separate the document and field with a double underscore. 
	- Here, we are looking for all watchlists created in the last week.
	- The embedded document is ```metadata```, then a double underscore, then the field to query, ```date_created```, then another double underscore, then the query operator, ```gte``` for greater than or equal to.

```python
import datetime

on_week = datetime.datetime.now().date() - datetime.timedelta(days=7)
recent_lists = Watchlist.objects(metadata__date_created__gte=one_week)
```

- To query an ```EmbeddedDocumentListField``` is almost the same.
	- Here, we are looking for a watchlist that contains bitcoin
	- The ```EmbeddedDocumentListField``` is ```coins```, then a double underscore, then the field in the embedded documents to query, ```coin```.

```python
bitcoin_watchlist = Watchlist.objects(coins__coin="bitcoin").first()
```


# Updating Embedded Document Lists

- Updating an embedded document list can be done using the List API as well. 
- Here, we are adding a new coin to the watchlist. 
- Since this coin is not in the database, we need to call the save method. 

```python
bears_watchlist = Watchlist.objects(name="Bears").first()

dogecoin = WatchlistCoin(coin="dogecoin", note="It's a Joke!")
bears_watchlist.coins.append(dogecoin)
bears_watchlist.save()
```
