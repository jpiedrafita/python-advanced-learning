
# Using SQLAlchemy

- SQLAlchemy is distributed as a Python package

```bash
pip install sqlalchemy
```

- All model classes must inherit from ```DeclarativeBase```
- Attribute to column mappings are defining using type annotations
- An engine connects to the database
- A session is used to interact with the databasa

# Implementing a Model Class

- By convention the class is named ```Base``` and inherits from the abstract metaclass ```DelcarativeBase```. Dataclasses cannot inherit directly.
	- Base can hold common attributes across modules or complex type mappings.
- The required attribute ```__tablename__``` will hold the name of the table.
	- It is convenient to use the lowercase normalized name.
- All mapped attributes are of type ```Mapped```.
- Initialize the attribute with the function ```mapped_column()```, which will infer the type of the column in the database from the type annotation. 
- Configure the primary key on the database side of the mapping with the keyword ```primary_key```.
- Columns can be configured further, for example the max lenght. Use each type from ```sqlalchemy```module, like ```String```or ```Numeric```.

```python
from sqlalchemy import String, Numeric
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column

class Base(DeclarativeBase)
pass

class Investment(Base):
	__tablename__ = "investment"
	id: Mapped[int] = mapped_column(primary_key=True)
	coin: Mapped[str] = mapped_column(String(32))
	currency: Mapped[str] = mapped_column(String(3))
	amount: Mapped[float] = mapped_column(Numeric(5, 2))
```

# Model Classes and the Database

- We need to create an engine to connect to the database using the function ```create_engine()```.
- Create the tables required by the subclases of ```Base``` by passing the engine to ```create_all()```.
- We can create an instance of the data class using the keyword arguments.
- Create a session from the engine to insert a row from the model class.
	- It is convenient to create the session in a ```with```statement so that it will be destroyed after the body is completed.
- Add the model instance to the session and commit to insert the row in the database
- To get the data back we use the Core API, which is a fluent API resembling SQL statements with Python syntax.
	- The ```select()```function will retrieve data from a model class, chaining methods as an SQL statement.
- Execute the statement in the session with ```execute()```. The return will be an instance of the model class

```python
from sqlalchemy import create_engine

engine = create_engine("sqlite:///data.db")
Base.metadata.create_all(engine)

bitcoin = investment(coin="bitcoin", currency="USD", amount=1.0)

with Session(engine) as session:
	session.add(bitcoin)
	session.commit()

	stmt = select(Investment).where(Investment.coin == "bitcoin")
	bitcoin = session.execute(stmt).scalar_one()

	print(f"{bitcoin.coin} - {bitcoin.currency} - {bitcoin.amount}")


```